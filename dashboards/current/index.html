<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Testing Agent - Dashboard</title>
    <style>
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 50%, #1e40af 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 18px;
        }
        
        .period-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0 0;
        }
        
        .period-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
        }
        
        .period-btn.active, .period-btn:hover {
            background: white;
            color: #2563eb;
            border-color: white;
            transform: translateY(-2px);
        }
        
        #account-select {
            transition: all 0.3s ease;
        }
        
        #account-select:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        #account-select:focus {
            background: white;
            color: #2563eb;
            border-color: white;
        }
        
        #account-select option {
            background: #2563eb;
            color: white;
        }
        
        .dropdown-btn {
            transition: all 0.3s ease;
        }
        
        .dropdown-btn:hover {
            background: rgba(255,255,255,0.3) !important;
            transform: translateY(-2px);
        }
        
        .dropdown-menu {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .dropdown-option {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s ease;
            color: #1d1d1f;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f2;
        }
        
        .dropdown-option:hover {
            background: #f5f5f7;
        }
        
        .dropdown-option.active {
            background: #2563eb;
            color: white;
            font-weight: 600;
        }
        
        .dropdown-option:first-child {
            border-radius: 12px 12px 0 0;
        }
        
        .dropdown-option:last-child {
            border-radius: 0 0 12px 12px;
            border-bottom: none;
        }
        
        /* Account selector - ajouté sans toucher au reste */
        .account-selector {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 15px 0 0;
        }
        
        .account-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 13px;
        }
        
        .account-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
        }
        
        .real-badge {
            background: #00a854;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 4px;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            margin: -40px 20px 40px;
            position: relative;
        }
        
        /* Première ligne : 3 KPI principaux */
        .kpi-card:nth-child(1),
        .kpi-card:nth-child(2),
        .kpi-card:nth-child(3) {
            grid-column: span 2;
        }
        
        /* Deuxième ligne : 2 KPI centrés */
        .kpi-card:nth-child(4) {
            grid-column: 2 / span 2;
        }
        
        .kpi-card:nth-child(5) {
            grid-column: span 2;
        }
        
        @media (max-width: 1200px) {
            .kpi-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .kpi-card {
                grid-column: span 1 !important;
            }
        }
        
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .kpi-card {
                grid-column: span 1 !important;
            }
        }
        
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .kpi-icon.blue { background: #e6f2ff; color: #0066cc; }
        .kpi-icon.green { background: #e6f9e6; color: #00a854; }
        .kpi-icon.purple { background: #f3e6ff; color: #7928ca; }
        .kpi-icon.yellow { background: #fff4e6; color: #ff9500; }
        
        .kpi-content h3 {
            font-size: 28px;
            margin-bottom: 4px;
        }
        
        .kpi-content p {
            color: #86868b;
            font-size: 14px;
        }
        
        .main-table-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            margin-bottom: 40px;
        }
        
        .main-table-card h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .main-table-card p {
            color: #86868b;
            margin-bottom: 24px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead th {
            background: #f5f5f7;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: #1d1d1f;
            border-bottom: 2px solid #e0e0e2;
        }
        
        tbody td {
            padding: 16px 12px;
            border-bottom: 1px solid #f0f0f2;
            font-size: 14px;
        }
        
        tbody tr:hover {
            background: #fafafa;
        }
        
        .ad-name {
            font-weight: 500;
            color: #1d1d1f;
        }
        
        .metric {
            font-weight: 600;
        }
        
        .roas-high { color: #00a854; }
        .roas-medium { color: #ff9500; }
        .roas-low { color: #ff3b30; }
        
        .format-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .format-video { background: #e6f2ff; color: #0066cc; }
        .format-image { background: #e6f9e6; color: #00a854; }
        .format-unknown { background: #f0f0f2; color: #86868b; }
        
        .media-link {
            text-decoration: none;
            font-size: 18px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .media-link:hover {
            opacity: 1;
        }
        
        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.active {
            background: #d4f4dd;
            color: #00a854;
        }
        
        .status-badge.paused {
            background: #ffe5e5;
            color: #ff3b30;
        }
        
        /* Editable fields */
        .hypothesis-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #e0e0e2;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }
        
        .hypothesis-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .result-select {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #e0e0e2;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
        }
        
        .result-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Filter row styles */
        .filter-row th {
            background: #f8f9fa;
            padding: 8px;
            border-bottom: 2px solid #e0e0e2;
        }
        
        .table-filter {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
        }
        
        .table-filter:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Export button */
        .export-btn {
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            height: 400px;
        }
        
        .chart-card h3 {
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 320px;
        }
        
        /* Graphiques CSS purs */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 240px;
            padding: 20px;
            padding-bottom: 80px; /* Plus d'espace en bas pour les labels */
            position: relative;
        }
        
        .bar {
            flex: 1;
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            margin: 0 8px;
            border-radius: 8px 8px 0 0;
            position: relative;
            min-height: 20px;
            transition: all 0.3s ease;
        }
        
        .bar:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .bar-label {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #86868b;
            white-space: nowrap;
            text-align: center;
        }
        
        .donut-chart {
            position: relative;
            padding: 20px;
        }
        
        .donut-svg {
            width: 180px;
            height: 180px;
            margin: 0 auto;
            display: block;
        }
        
        
        .legend {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            font-size: 13px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
        }
        
        .legend-item span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        
        /* Coming Soon section */
        .coming-soon {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            margin-top: 40px;
            border: 2px dashed #e0e0e2;
        }
        
        .coming-soon h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #1d1d1f;
        }
        
        .coming-soon > p {
            color: #86868b;
            margin-bottom: 24px;
        }
        
        .coming-soon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .coming-soon-item {
            padding: 20px;
            background: #f5f5f7;
            border-radius: 8px;
        }
        
        .coming-soon-item h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #1d1d1f;
        }
        
        .coming-soon-item p {
            font-size: 14px;
            color: #86868b;
        }
        
        /* Preview Section Styles */
        .preview-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            margin-bottom: 40px;
            position: relative;
            border: 2px dashed #e0e0e2;
        }
        
        .preview-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff9500;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .preview-content {
            opacity: 1.0;
            pointer-events: none;
            user-select: none;
        }
        
        .unlock-message {
            text-align: center;
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .unlock-message h3 {
            color: #1d1d1f;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .unlock-message p {
            color: #6c757d;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .nomenclature-example {
            background: #667eea;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-weight: 600;
            letter-spacing: 1px;
            margin: 15px 0;
            display: inline-block;
        }
        
        .unlock-btn {
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s ease;
            font-size: 16px;
        }
        
        .unlock-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* Creator cards styles */
        .creator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            padding: 20px;
        }
        
        .creator-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .creator-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .creator-avatar {
            font-size: 32px;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .creator-avatar.male {
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
        }
        
        .creator-avatar.female {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .creator-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            color: #1d1d1f;
        }
        
        .creator-stats {
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .creator-roas {
            font-weight: 700;
            color: #00a854;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚀 Creative Testing Dashboard</h1>
        <p>Análisis de rendimiento creativo • Datos hasta: 25/08/2025</p>
        
        <div class="period-selector">
            <button class="period-btn" onclick="switchPeriod(this, 3)">3 días</button>
            <button class="period-btn active" onclick="switchPeriod(this, 7)">7 días</button>
            <button class="period-btn" onclick="switchPeriod(this, 14)">14 días</button>
            <button class="period-btn" onclick="switchPeriod(this, 30)">30 días</button>
            <button class="period-btn" onclick="switchPeriod(this, 90)">90 días</button>
        </div>
        
        <div class="account-selector" style="margin-top:15px; display:flex; justify-content:center; gap:8px; align-items:center;">
            <div class="custom-dropdown" style="position: relative;">
                <button id="account-dropdown-btn" class="dropdown-btn" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; padding-right: 35px; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 14px; min-width: 150px; max-width: 280px; outline: none; text-align: center; position: relative;">
                    <span id="account-dropdown-text">Todas las cuentas</span>
                    <svg style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); transition: transform 0.3s;" width="12" height="12" viewBox="0 0 20 20" fill="white">
                        <path d="M10 12L6 8h8z"/>
                    </svg>
                </button>
                <div id="account-dropdown-menu" class="dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 5px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 400px; overflow-y: auto; z-index: 1000;">
                    <!-- Options will be added dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-content">
                    <h3>1609</h3>
                    <p>Anuncios Activos</p>
                </div>
                <div class="kpi-icon blue">📊</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-content">
                    <h3>$1,569,802</h3>
                    <p>Inversión Total (MXN)</p>
                </div>
                <div class="kpi-icon green">💰</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-content">
                    <h3>3.42</h3>
                    <p>ROAS Promedio</p>
                </div>
                <div class="kpi-icon purple">📈</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-content">
                    <h3>$0</h3>
                    <p>Valor de Conversión</p>
                </div>
                <div class="kpi-icon yellow">💵</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-content">
                    <h3>$0</h3>
                    <p>CPA Promedio</p>
                </div>
                <div class="kpi-icon yellow">🎯</div>
            </div>
        </div>
        
        <div class="chart-grid">
            <div class="chart-card">
                <h3>💰 Top 5 Cuentas por Inversión</h3>
                <div class="bar-chart">
                    <div class="bar" style="height: 100.0%">
                        <span class="bar-value">$236k</span>
                        <span class="bar-label">Chabacano </span>
                    </div>
                    <div class="bar" style="height: 63.65769961648871%">
                        <span class="bar-value">$150k</span>
                        <span class="bar-label">VITDAYMX</span>
                    </div>
                    <div class="bar" style="height: 50.73332220430585%">
                        <span class="bar-value">$120k</span>
                        <span class="bar-label">Charm Fact</span>
                    </div>
                    <div class="bar" style="height: 40.22805222606504%">
                        <span class="bar-value">$95k</span>
                        <span class="bar-label">PUBLICIDAD</span>
                    </div>
                    <div class="bar" style="height: 36.15435836867869%">
                        <span class="bar-value">$85k</span>
                        <span class="bar-label">Entiii</span>
                    </div>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>📊 Distribución por Formato</h3>
                <div class="donut-chart">
                    <svg class="donut-svg" viewBox="0 0 180 180">
                        <circle cx="90" cy="90" r="60" fill="none" stroke="#667eea" 
                                stroke-width="30" stroke-dasharray="191 377" 
                                stroke-dashoffset="-0" transform="rotate(-90 90 90)"></circle>
                        <circle cx="90" cy="90" r="60" fill="none" stroke="#00a854" 
                                stroke-width="30" stroke-dasharray="128 377" 
                                stroke-dashoffset="-191" transform="rotate(-90 90 90)"></circle>
                        <circle cx="90" cy="90" r="60" fill="none" stroke="#7928ca" 
                                stroke-width="30" stroke-dasharray="49 377" 
                                stroke-dashoffset="-319" transform="rotate(-90 90 90)"></circle>
                        <circle cx="90" cy="90" r="60" fill="none" stroke="#86868b" 
                                stroke-width="30" stroke-dasharray="9 377" 
                                stroke-dashoffset="-368" transform="rotate(-90 90 90)"></circle>
                        <circle cx="90" cy="90" r="30" fill="white"></circle>
                    </svg>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #667eea"></div>
                            <span>VIDEO (816) • ROAS: 2.85</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #00a854"></div>
                            <span>IMAGE (547) • ROAS: 3.24</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #7928ca"></div>
                            <span>INSTAGRAM (207) • ROAS: 3.76</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #86868b"></div>
                            <span>OTROS (39)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-table-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2>Top 10 Anuncios por ROAS</h2>
                    <p>Solo anuncios con inversión mayor a $3,000 MXN</p>
                </div>
                <button id="export-excel" class="export-btn">
                    📊 Exportar a Excel
                </button>
            </div>
            
            <table id="ads-table">
                <thead>
                    <tr>
                        <th>Anuncio</th>
                        <th>Estado</th>
                        <th>Formato</th>
                        <th>Fecha Inicio</th>
                        <th>Importe Gastado</th>
                        <th>ROAS</th>
                        <th>CPA</th>
                        <th>Compras</th>
                        <th>Ver</th>
                        <th>Hipótesis</th>
                        <th>Resultado</th>
                    </tr>
                    <tr class="filter-row">
                        <th><input type="text" class="table-filter" data-column="0" placeholder="Filtrar..."></th>
                        <th>
                            <select class="table-filter" data-column="1">
                                <option value="">Todos</option>
                                <option value="active">Activo</option>
                                <option value="paused">Pausado</option>
                            </select>
                        </th>
                        <th>
                            <select class="table-filter" data-column="2">
                                <option value="">Todos</option>
                                <option value="video">Video</option>
                                <option value="image">Image</option>
                                <option value="carousel">Carousel</option>
                                <option value="unknown">Otros</option>
                            </select>
                        </th>
                        <th><input type="date" class="table-filter" data-column="3"></th>
                        <th><input type="number" class="table-filter" data-column="4" placeholder="Min..."></th>
                        <th><input type="number" class="table-filter" data-column="5" placeholder="Min..." step="0.01"></th>
                        <th><input type="number" class="table-filter" data-column="6" placeholder="Max..."></th>
                        <th><input type="number" class="table-filter" data-column="7" placeholder="Min..."></th>
                        <th></th>
                        <th><input type="text" class="table-filter" data-column="9" placeholder="Filtrar..."></th>
                        <th>
                            <select class="table-filter" data-column="10">
                                <option value="">Todos</option>
                                <option value="ganador">Ganador</option>
                                <option value="perdedor">Perdedor</option>
                            </select>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="ad-name">video | Creadora | inhouse | 3...</td>
                        <td>Pautas Citlali Joyas</td>
                        <td><span class="format-badge format-video">VIDEO</span></td>
                        <td class="metric roas-high">11.90</td>
                        <td class="metric">$4,367</td>
                        <td>3.73%</td>
                        <td><a href="https://www.facebook.com/watch/?v=1259504028645569" target="_blank" class="media-link">🎬</a></td>
                    </tr>
                    <tr>
                        <td class="ad-name">Aniversario...</td>
                        <td>Ana Sol Carrera</td>
                        <td><span class="format-badge format-unknown">UNKNOWN</span></td>
                        <td class="metric roas-high">11.12</td>
                        <td class="metric">$5,673</td>
                        <td>0.71%</td>
                        <td>—</td>
                    </tr>
                    <tr>
                        <td class="ad-name">17.06.25-v2_h123-Isolate-MOI - Copia...</td>
                        <td>Essentiasl Mx</td>
                        <td><span class="format-badge format-video">VIDEO</span></td>
                        <td class="metric roas-high">10.50</td>
                        <td class="metric">$4,511</td>
                        <td>0.94%</td>
                        <td><a href="https://www.facebook.com/watch/?v=1039576621712946" target="_blank" class="media-link">🎬</a></td>
                    </tr>
                    <tr>
                        <td class="ad-name">Estaticos - Agosto 22...</td>
                        <td>Charm Factory - Ads Alche</td>
                        <td><span class="format-badge format-image">IMAGE</span></td>
                        <td class="metric roas-high">7.99</td>
                        <td class="metric">$3,302</td>
                        <td>1.29%</td>
                        <td><a href="https://scontent.fsdu13-1.fna.fbcdn.net/v/t45.1600-4/534473928_1983753199119302_5690379743082317490_n.png?stp=dst-jpg_tt6&_nc_cat=103&ccb=1-7&_nc_sid=890911&_nc_ohc=hziKHzxRMjsQ7kNvwHrjlDs&_nc_oc=AdkbBCRgLU34JaZie4mJB8GcNK31dmvLYanNZadeqgKAjK-4zHTrSIuV1AULZfbdXsw&_nc_zt=1&_nc_ht=scontent.fsdu13-1.fna&edm=AAwGEdEEAAAA&_nc_gid=nTAZizyeYlovr96lLZweww&oh=00_AfUUjUar77wdE3UKg_qrJRqlVtRsaHfF8ymwGGk_II69bQ&oe=68B3872F" target="_blank" class="media-link">🖼️</a></td>
                    </tr>
                    <tr>
                        <td class="ad-name">Hook 1...</td>
                        <td>Kocare Beauty</td>
                        <td><span class="format-badge format-instagram">INSTAGRAM</span></td>
                        <td class="metric roas-high">7.56</td>
                        <td class="metric">$4,386</td>
                        <td>2.12%</td>
                        <td><a href="https://www.instagram.com/p/DMy7dZSMJKH/" target="_blank" class="media-link">🖼️</a></td>
                    </tr>
                    <tr>
                        <td class="ad-name">Hook1 - Copy...</td>
                        <td>Chabacano 1</td>
                        <td><span class="format-badge format-image">IMAGE</span></td>
                        <td class="metric roas-high">7.39</td>
                        <td class="metric">$3,468</td>
                        <td>1.11%</td>
                        <td><a href="https://scontent.fsdu13-1.fna.fbcdn.net/v/t45.1600-4/454601043_120213209611970247_1757152159245297555_n.png?stp=dst-jpg_tt6&_nc_cat=102&ccb=1-7&_nc_sid=890911&_nc_ohc=q-K_FA2K9ZgQ7kNvwEHbN_R&_nc_oc=AdmVhD_BJys8qK6dAwJcFV8nmlkHHA0akAo_Wa4xrRaTz74DrjSzzyS0HuG0rHsi0xE&_nc_zt=1&_nc_ht=scontent.fsdu13-1.fna&edm=AAwGEdEEAAAA&_nc_gid=eNDyX87G3aJMkW-uPjCdNA&oh=00_AfVVygSiBp-31C8yeOEekIeCjLjn20u130sBvv2e7rOXhQ&oe=68B38E42" target="_blank" class="media-link">🖼️</a></td>
                    </tr>
                    <tr>
                        <td class="ad-name">Imagen 1...</td>
                        <td>Chabacano 1</td>
                        <td><span class="format-badge format-image">IMAGE</span></td>
                        <td class="metric roas-high">7.14</td>
                        <td class="metric">$3,287</td>
                        <td>1.63%</td>
                        <td><a href="https://scontent.fsdu13-1.fna.fbcdn.net/v/t45.1600-4/476815954_120218124362870247_3660302703167646447_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=890911&_nc_ohc=Ve5QUy9YpjUQ7kNvwHRrkw8&_nc_oc=Adljk93lzd6f6m0mBV1QHYNsCWp7UaOgZOuwWD0X7GuVvyO0MQ_Yo05ySUsYHLly-J4&_nc_zt=1&_nc_ht=scontent.fsdu13-1.fna&edm=AAwGEdEEAAAA&_nc_gid=eNDyX87G3aJMkW-uPjCdNA&oh=00_AfXRbd1--DKZjL_EiNgEzedhFhNKbSITQIt_kSqzpLW20w&oe=68B39F35" target="_blank" class="media-link">🖼️</a></td>
                    </tr>
                    <tr>
                        <td class="ad-name">Hook 1,2 y3...</td>
                        <td>Regula</td>
                        <td><span class="format-badge format-image">IMAGE</span></td>
                        <td class="metric roas-high">6.71</td>
                        <td class="metric">$6,723</td>
                        <td>0.89%</td>
                        <td><a href="https://scontent.fsdu13-1.fna.fbcdn.net/v/t45.1600-4/532567125_1145820754265063_3966431700177067799_n.png?stp=dst-jpg_tt6&_nc_cat=110&ccb=1-7&_nc_sid=890911&_nc_ohc=HN3636VW97sQ7kNvwFbAz4i&_nc_oc=Adl5Lmn4TNaosLg_K_cCka2smMPQoN_UmLKu8HiYusoqo_z2h9OWVOYik-Qcp-74XX8&_nc_zt=1&_nc_ht=scontent.fsdu13-1.fna&edm=AAwGEdEEAAAA&_nc_gid=xzLJZJ2Ylo_Fs4avhHfznQ&oh=00_AfXe7CcPeB6ZjLmZ82urMwwd46UNkzCJKM3mY1aaqBhstw&oe=68B396B2" target="_blank" class="media-link">🖼️</a></td>
                    </tr>
                    <tr>
                        <td class="ad-name">Batch 68  hook 1...</td>
                        <td>Chabacano 1</td>
                        <td><span class="format-badge format-video">VIDEO</span></td>
                        <td class="metric roas-high">6.45</td>
                        <td class="metric">$3,472</td>
                        <td>1.68%</td>
                        <td><a href="https://www.facebook.com/watch/?v=1014737480484127" target="_blank" class="media-link">🎬</a></td>
                    </tr>
                    <tr>
                        <td class="ad-name">Hook2...</td>
                        <td>Cuenta Comercial 2</td>
                        <td><span class="format-badge format-instagram">INSTAGRAM</span></td>
                        <td class="metric roas-high">6.10</td>
                        <td class="metric">$4,129</td>
                        <td>1.65%</td>
                        <td><a href="https://www.instagram.com/p/DI_eyLfMJPV/" target="_blank" class="media-link">🖼️</a></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- TABLA EFICIENCIA POR FORMATO -->
        <div class="main-table-card">
            <h2>📊 Eficiencia por Tipo de Formato</h2>
            <p id="formato-subtitle">Análisis comparativo de rendimiento por formato creativo</p>
            
            <table>
                <thead>
                    <tr>
                        <th>Formato</th>
                        <th>Cantidad</th>
                        <th>Inversión Total</th>
                        <th>ROAS Promedio</th>
                        <th>CPA</th>
                        <th>Compras</th>
                        <th>CTR Promedio</th>
                    </tr>
                </thead>
                <tbody id="formato-table">
                    <!-- Será llenado por JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- TABLA COMPARACIÓN SEMANA A SEMANA -->
        <div class="main-table-card">
            <h2>📈 Comparación Semana a Semana</h2>
            <p>Comparación entre semana actual (19-25 ago) vs semana anterior (12-18 ago)</p>
            
            <table>
                <thead>
                    <tr>
                        <th>Métrica</th>
                        <th>Semana Actual</th>
                        <th>Semana Anterior</th>
                        <th>Cambio</th>
                    </tr>
                </thead>
                <tbody id="comparison-table">
                    <!-- Será llenado por JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- SECTION DEMOGRAPHICS -->
        <div class="demographics-section" style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); margin-bottom: 40px;">
            <h2>📊 Análisis Demográfico</h2>
            <p style="color: #86868b; margin-bottom: 20px;">Distribución del gasto por edad y género</p>
            
            <div id="demographics-content">
                <div style="padding: 40px; text-align: center; background: #f5f5f7; border-radius: 8px;">
                    <p style="color: #86868b; margin-bottom: 15px;">
                        📈 Los datos demográficos se cargarán bajo demanda para optimizar el rendimiento
                    </p>
                    <button id="load-demographics" class="export-btn" style="background: linear-gradient(135deg, #00a854 0%, #28a745 100%);">
                        Cargar Análisis Demográfico
                    </button>
                </div>
            </div>
            
            <!-- Template para cuando se carguen los datos -->
            <div id="demographics-loaded" style="display: none;">
                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>👥 Distribución por Edad</h3>
                        <div id="age-distribution"></div>
                    </div>
                    <div class="chart-card">
                        <h3>⚧ Distribución por Género</h3>
                        <div id="gender-distribution"></div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3 style="font-size: 16px; margin-bottom: 15px;">Tabla Detallada por Segmento</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Segmento</th>
                                <th>Inversión</th>
                                <th>ROAS</th>
                                <th>CTR</th>
                                <th>CPA</th>
                                <th>Conversiones</th>
                            </tr>
                        </thead>
                        <tbody id="demographics-table">
                            <!-- Será llenado dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- SECTION NOMENCLATURA PETCARE -->
        <div class="preview-section" id="petcare-section" style="display: none;">
            <div class="preview-badge" style="background: #00a854;">PETCARE 2 - DATOS REALES</div>
            
            <h2>🐕 Análisis por Nomenclatura - Petcare 2</h2>
            <p style="color: #86868b; margin-bottom: 25px;">Análisis real basado en la nomenclatura implementada (27% de ads con nomenclatura)</p>
            
            <div class="preview-content">
                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>📊 Top 5 Ángulos Creativos (min $500 spend)</h3>
                        <div class="bar-chart" id="petcare-angles-chart">
                            <div class="bar" style="height: 100%; background: linear-gradient(135deg, #00a854 0%, #28a745 100%);">
                                <span class="bar-value">ROAS 4.9</span>
                                <span class="bar-label">Problemas Digestivos • $1.6K</span>
                            </div>
                            <div class="bar" style="height: 61%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <span class="bar-value">ROAS 3.0</span>
                                <span class="bar-label">Lamido de patas • $2.3K</span>
                            </div>
                            <div class="bar" style="height: 43%; background: linear-gradient(135deg, #ff9500 0%, #ff8c00 100%);">
                                <span class="bar-value">ROAS 2.1</span>
                                <span class="bar-label">Bienestar General • $4.2K</span>
                            </div>
                            <div class="bar" style="height: 36%; background: linear-gradient(135deg, #7928ca 0%, #9c27b0 100%);">
                                <span class="bar-value">ROAS 1.8</span>
                                <span class="bar-label">RESTOCK • $1.4K</span>
                            </div>
                            <div class="bar" style="height: 28%; background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);">
                                <span class="bar-value">ROAS 1.4</span>
                                <span class="bar-label">Olor a chetos • $5.2K</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3>👥 Performance por Creador (Datos Reales)</h3>
                        <div class="creator-grid" id="petcare-creators-grid">
                            <div class="creator-card">
                                <div class="creator-avatar female">👩</div>
                                <div class="creator-name">Melissa</div>
                                <div class="creator-stats">
                                    ROAS: <span class="creator-roas">2.1x</span><br>
                                    7 ads • $4.2K
                                </div>
                            </div>
                            <div class="creator-card">
                                <div class="creator-avatar male">👨</div>
                                <div class="creator-name">Martin</div>
                                <div class="creator-stats">
                                    ROAS: <span class="creator-roas">1.1x</span><br>
                                    7 ads • $4.1K
                                </div>
                            </div>
                            <div class="creator-card">
                                <div class="creator-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">🤖</div>
                                <div class="creator-name">Voz IA</div>
                                <div class="creator-stats">
                                    ROAS: <span class="creator-roas">1.0x</span><br>
                                    7 ads • $6.0K
                                </div>
                            </div>
                            <div class="creator-card" style="grid-column: span 3; margin-top: 20px; background: #f5f5f7; padding: 20px;">
                                <h4 style="margin-bottom: 10px;">📈 Insights Clave Petcare:</h4>
                                <div style="display: flex; justify-content: space-around; text-align: center;">
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: #00a854;">86%</div>
                                        <div style="font-size: 12px; color: #86868b;">Nuevo vs 14% Iteración</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: #667eea;">1.86x</div>
                                        <div style="font-size: 12px; color: #86868b;">ROAS Nuevos</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: #ff9500;">159/595</div>
                                        <div style="font-size: 12px; color: #86868b;">Ads con nomenclatura</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Helper: try multiple paths for local JSON
        async function loadJSON(paths) {
            // Simplifié: source de vérité = data/current
            const path = Array.isArray(paths) ? paths[0] : paths;
            const res = await fetch(path);
            if (!res.ok) throw new Error('Load failed: ' + path);
            return await res.json();
        }
        // Charger toutes les données au démarrage
        let periodsData = {};
        let prevWeekData = {};
        let currentPeriod = 7;
        let currentAccount = 'global';  // Nouveau: track du compte actuel
        let petcareData = {};  // Nouveau: données Petcare
        let accountsIndex = null; // Index complet des comptes si disponible
        
        async function loadAllData() {
            try {
                // Charger progressivement du plus léger au plus lourd
                console.log('⏳ Chargement 7j...');
                periodsData[7] = await loadJSON('../../data/current/hybrid_data_7d.json');
                
                // Afficher immédiatement avec 7j
                updateDashboard(7);
                console.log('✅ 7j chargé et affiché');
                
                // Charger le reste progressivement en arrière-plan
                loadJSON('../../data/current/hybrid_data_3d.json')
                    .then(data => { 
                        periodsData[3] = data;
                        console.log('✅ 3j chargé');
                    });
                
                loadJSON('../../data/current/hybrid_data_14d.json')
                    .then(data => { 
                        periodsData[14] = data;
                        console.log('✅ 14j chargé');
                    });
                
                setTimeout(() => {
                    loadJSON('../../data/current/hybrid_data_30d.json')
                        .then(data => { 
                            periodsData[30] = data;
                            console.log('✅ 30j chargé');
                        });
                }, 500); // Petit délai pour 30j
                
                setTimeout(() => {
                    loadJSON('../../data/current/hybrid_data_90d.json')
                        .then(data => { 
                            periodsData[90] = data;
                            console.log('✅ 90j chargé (340MB!)');
                        });
                }, 1000); // Délai plus long pour 90j
                
                // Charger semaine précédente
                prevWeekData = await loadJSON(
                    '../../data/current/hybrid_data_prev_week.json'
                );
                
                // Vérifier disponibilité des données Petcare pour activer/désactiver le bouton
                try {
                    await loadJSON(
                        '../../data/current/petcare_parsed_analysis.json'
                    );
                } catch (e) {
                        const btn = document.getElementById('petcare-btn');
                        if (btn) { btn.disabled = true; btn.style.opacity = '0.6'; btn.title = 'Datos Petcare no disponibles'; }
                }

                // Charger l'index des comptes si présent
                try {
                    accountsIndex = await loadJSON('../../data/current/accounts_index.json');
                    console.log('👥 Accounts index loaded:', accountsIndex.total, 'comptes');
                } catch (e) {
                    accountsIndex = null;
                }

                console.log('📊 Données chargées:', Object.keys(periodsData), 'prev_week');
                
                // Initialiser avec 7 jours
                updateDashboard(7);
                
            } catch (error) {
                console.error('❌ Erreur chargement données:', error);
            }
        }
        
        function switchPeriod(button, days) {
            currentPeriod = days;
            
            // Vérifier si les données sont chargées
            if (!periodsData[days]) {
                console.log(`⏳ Données ${days}j pas encore chargées...`);
                button.textContent = `${days}j ⏳`;
                
                // Attendre que les données soient chargées
                const checkInterval = setInterval(() => {
                    if (periodsData[days]) {
                        clearInterval(checkInterval);
                        button.textContent = `${days}j`;
                        switchPeriod(button, days); // Réessayer
                    }
                }, 500); // Vérifier toutes les 500ms
                
                // Timeout après 30 secondes
                setTimeout(() => {
                    clearInterval(checkInterval);
                    button.textContent = `${days}j ❌`;
                }, 30000);
                return;
            }
            
            try {
                const n = periodsData[days] && periodsData[days].ads ? periodsData[days].ads.length : 0;
                console.log('🔄 Switching period ->', days, 'days; ads:', n);
            } catch (e) { console.warn('switchPeriod log error', e); }
            
            // ✅ Mettre à jour les boutons (corrigé)
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            // Mettre à jour le contenu
            updateDashboard(days);
        }
        
        // Nouveau: fonction pour changer de compte
        function switchAccount(button, account) {
            currentAccount = account;
            
            // Mettre à jour les boutons
            document.querySelectorAll('.account-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            if (account === 'petcare') {
                // Mode Petcare: afficher les vraies analyses
                window.location.href = 'petcare_real_analysis.html';
            } else {
                // Mode Global: on reste sur cette page avec tous les tableaux
            buildAccountOptions();
            updateDashboard(currentPeriod);
        }
        }
        
        function updateDashboard(days) {
            const data = periodsData[days];
            if (!data) {
                console.error(`Pas de données pour ${days} jours`);
                return;
            }
            console.log('✅ Rendering period', days, 'ads:', data.ads ? data.ads.length : 'n/a');
            // Build a view data with filtered ads and recomputed distribution
            const viewAds = filterAdsByAccount(data.ads || []);
            const viewData = { ...data, ads: viewAds, format_distribution: computeFormatDistribution(viewAds) };

            updateKPIs(viewData);
            updateCharts(viewData);
            updateTable(viewData);
            updateFormatTable(viewData);
            updateComparisonTable();
            
            // Afficher/masquer la section Petcare selon le compte sélectionné
            const petcareSection = document.getElementById('petcare-section');
            if (petcareSection) {
                petcareSection.style.display = currentAccountName === 'Petcare 2' ? 'block' : 'none';
            }
        }
        
        function updateKPIs(data) {
            const ads = data.ads || [];
            // Compter seulement les ads ACTIVES
            const activeAds = ads.filter(ad => ad.effective_status === 'ACTIVE').length;
            const totalAds = ads.length;
            // Convertir spend de string à number
            const totalSpend = ads.reduce((sum, ad) => sum + parseFloat(ad.spend || 0), 0);
            const totalRevenue = ads.reduce((sum, ad) => sum + (ad.purchase_value || 0), 0);
            const totalPurchases = ads.reduce((sum, ad) => sum + (ad.purchases || 0), 0);
            const avgRoas = totalSpend > 0 ? (totalRevenue / totalSpend) : 0;
            const cpa = totalPurchases > 0 ? (totalSpend / totalPurchases) : 0;
            
            // Mettre à jour les valeurs dans les KPI cards (5 cartes désormais)
            const kpiCards = document.querySelectorAll('.kpi-content');
            if (kpiCards.length >= 5) {
                // KPI 1: Anuncios Activos avec total
                kpiCards[0].innerHTML = `
                    <h3 style="margin-bottom: 5px;">${activeAds.toLocaleString()}</h3>
                    <p style="margin-bottom: 2px;">Anuncios Activos</p>
                    <p style="font-size: 11px; color: #86868b; margin: 0;">${totalAds.toLocaleString()} total</p>
                `;
                
                // Autres KPIs restent simples
                kpiCards[1].querySelector('h3').textContent = `$${Math.round(totalSpend).toLocaleString()}`;
                kpiCards[2].querySelector('h3').textContent = avgRoas.toFixed(2);
                kpiCards[3].querySelector('h3').textContent = `$${Math.round(totalRevenue).toLocaleString()}`;
                kpiCards[4].querySelector('h3').textContent = cpa > 0 ? `$${cpa.toFixed(2)}` : 'N/A';
            }
        }
        
        function updateCharts(data) {
            const ads = data.ads || [];
            
            // Changer le titre et le contenu selon la sélection
            const chartTitle = document.querySelector('.chart-card h3');
            const barChart = document.querySelector('.bar-chart');
            
            if (currentAccountName === 'Todos') {
                // Mode TODOS: Top 5 comptes par spend
                if (chartTitle) chartTitle.textContent = '💰 Top 5 Cuentas por Inversión';
                
                const accountSpend = {};
                ads.forEach(ad => {
                    if (!accountSpend[ad.account_name]) accountSpend[ad.account_name] = 0;
                    accountSpend[ad.account_name] += parseFloat(ad.spend || 0);
                });
                
                const topAccounts = Object.entries(accountSpend)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                const maxSpend = topAccounts[0] ? topAccounts[0][1] : 1;
                
                if (barChart) {
                    barChart.innerHTML = topAccounts.map(([name, spend]) => `
                        <div class="bar" style="height: ${(spend/maxSpend*100)}%">
                            <span class="bar-value">$${Math.round(spend/1000)}k</span>
                            <span class="bar-label">${name.substring(0, 10)}</span>
                        </div>
                    `).join('');
                }
            } else {
                // Mode COMPTE SPÉCIFIQUE: Top 5 anuncios par spend
                if (chartTitle) chartTitle.textContent = `🎯 Top 5 Anuncios de ${currentAccountName.substring(0, 20)}`;
                
                // Filtrer et trier les anuncios par spend
                const topAds = ads
                    .filter(ad => parseFloat(ad.spend || 0) > 0)
                    .sort((a, b) => parseFloat(b.spend || 0) - parseFloat(a.spend || 0))
                    .slice(0, 5);
                
                const maxSpend = topAds[0] ? parseFloat(topAds[0].spend) : 1;
                
                if (barChart) {
                    barChart.innerHTML = topAds.map(ad => {
                        const spend = parseFloat(ad.spend || 0);
                        // Mêmes seuils que les icônes : 2.5+ vert, 1.5+ orange, <1.5 rouge
                        const roasClass = ad.roas >= 2.5 ? '#00a854' : ad.roas >= 1.5 ? '#ff9500' : '#ff3b30';
                        return `
                            <div class="bar" style="height: ${(spend/maxSpend*100)}%; background: linear-gradient(135deg, ${roasClass} 0%, ${roasClass}99 100%);">
                                <span class="bar-value">$${Math.round(spend/1000)}k</span>
                                <span class="bar-label" title="${ad.ad_name}">${ad.ad_name.substring(0, 10)}</span>
                            </div>
                        `;
                    }).join('');
                    
                    // Ajouter une légende ROAS séparée sous le graphique avec icônes
                    barChart.innerHTML += `
                        <div style="position: absolute; bottom: -50px; left: 0; right: 0; display: flex; justify-content: space-around; font-size: 11px; color: #86868b;">
                            ${topAds.map(ad => {
                                // Seuils ajustés : 2.5+ excellent, 1.5+ bien, <1.5 à améliorer
                                const icon = ad.roas >= 2.5 ? '✅' : ad.roas >= 1.5 ? '⚠️' : '❌';
                                const color = ad.roas >= 2.5 ? '#00a854' : ad.roas >= 1.5 ? '#ff9500' : '#ff3b30';
                                return `<span style="color: ${color}">ROAS ${ad.roas.toFixed(1)} ${icon}</span>`;
                            }).join('')}
                        </div>
                    `;
                }
            }
            
            // Mettre à jour le donut chart ET la légende des formats avec ROAS
            const formatStats = data.format_distribution || {};
            const formatRoas = calculateFormatRoas(ads);
            
            // Filtrer CAROUSEL dès le début pour éviter l'espace vide
            const filteredFormats = Object.entries(formatStats)
                .filter(([fmt]) => fmt !== 'CAROUSEL');
            
            // Calculer le total APRÈS le filtrage
            const total = filteredFormats.reduce((sum, [_, count]) => sum + count, 0);
            const circumference = 2 * Math.PI * 60; // rayon = 60
            
            // Générer le SVG dynamiquement
            const donutSvg = document.querySelector('.donut-svg');
            if (donutSvg && total > 0) {
                let offset = 0;
                const segments = filteredFormats
                    .map(([format, count]) => {
                        const percentage = count / total;
                        const dashLength = circumference * percentage;
                        const currentOffset = offset;
                        offset += dashLength;
                        
                        return `<circle cx="90" cy="90" r="60" 
                                fill="none" 
                                stroke="${getFormatColor(format)}" 
                                stroke-width="30" 
                                stroke-dasharray="${dashLength} ${circumference}" 
                                stroke-dashoffset="-${currentOffset}" 
                                transform="rotate(-90 90 90)"></circle>`;
                    }).join('');
                
                donutSvg.innerHTML = segments + '<circle cx="90" cy="90" r="30" fill="white"></circle>';
            }
            
            const legend = document.querySelector('.legend');
            if (legend) {
                legend.innerHTML = filteredFormats
                    .map(([fmt, count]) => {
                        const roas = formatRoas[fmt] || 0;
                        // Raccourcir les noms
                        const shortName = fmt === 'INSTAGRAM' ? 'IG' : 
                                         fmt === 'UNKNOWN' ? 'OTROS' : fmt;
                        return `
                            <div class="legend-item">
                                <div class="legend-color" style="background: ${getFormatColor(fmt)}"></div>
                                <span>${shortName} (${count})${roas > 0 ? ` • ROAS:${roas.toFixed(2)}` : ''}</span>
                            </div>
                        `;
                    }).join('');
            }
        }
        
        function calculateFormatRoas(ads) {
            const formatMetrics = {};
            
            ads.forEach(ad => {
                const fmt = ad.format;
                if (!formatMetrics[fmt]) {
                    formatMetrics[fmt] = { totalSpend: 0, totalRevenue: 0 };
                }
                formatMetrics[fmt].totalSpend += parseFloat(ad.spend || 0);
                formatMetrics[fmt].totalRevenue += ad.purchase_value;
            });
            
            // ✅ ROAS pondéré par spend (correct)
            const formatRoas = {};
            Object.keys(formatMetrics).forEach(fmt => {
                const { totalSpend, totalRevenue } = formatMetrics[fmt];
                formatRoas[fmt] = totalSpend > 0 ? totalRevenue / totalSpend : 0;
            });
            
            return formatRoas;
        }
        
        function getFormatColor(format) {
            const colors = {
                'VIDEO': '#0ea5e9',      // Bleu clair
                'IMAGE': '#2563eb',      // Bleu moyen
                'INSTAGRAM': '#1e40af',  // Bleu foncé
                'UNKNOWN': '#94a3b8',    // Gris-bleu
                'CAROUSEL': '#06b6d4'    // Cyan
            };
            return colors[format] || '#ccc';
        }
        
        // Stocker les données actuelles pour le filtrage
        let currentTableData = [];
        let filteredTableData = [];
        
        // Variables de pagination
        let currentPage = 1;
        const itemsPerPage = 10;
        
        function updateTable(data) {
            const ads = data.ads || [];
            // Afficher TOUS les anuncios triés par Importe Gastado décroissant
            currentTableData = [...ads].sort((a, b) => parseFloat(b.spend || 0) - parseFloat(a.spend || 0));
            filteredTableData = currentTableData; // Par défaut, pas de filtre
            currentPage = 1; // Réinitialiser à la première page
            
            // Appliquer les filtres si nécessaire
            const spendFilter = document.querySelector('.table-filter[data-column="4"]');
            if (spendFilter && spendFilter.value) {
                // Appliquer le filtre après avoir défini currentTableData
                setTimeout(() => {
                    window.applyTableFilters();
                }, 100);
            } else {
                renderTable();
            }
        }
        
        function renderTable() {
            // Mettre à jour le titre de la table
            const tableTitle = document.querySelector('.main-table-card h2');
            if (tableTitle) {
                tableTitle.textContent = `Historial de Anuncios (${currentPeriod} días)`;
            }
            
            // Calculer la pagination
            const totalPages = Math.ceil(filteredTableData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredTableData.slice(startIndex, endIndex);
            
            const tableSubtitle = document.querySelector('.main-table-card p');
            if (tableSubtitle) {
                const filterInfo = filteredTableData.length < currentTableData.length 
                    ? ` (${filteredTableData.length} filtrados de ${currentTableData.length})`
                    : '';
                tableSubtitle.textContent = `Mostrando ${startIndex + 1}-${Math.min(endIndex, filteredTableData.length)} de ${filteredTableData.length.toLocaleString()} anuncios${filterInfo}`;
            }
            
            // Charger les données sauvegardées depuis localStorage
            const savedData = JSON.parse(localStorage.getItem('adHypotheses') || '{}');
            
            // Mettre à jour le tbody
            const tableBody = document.querySelector('#ads-table tbody');
            if (tableBody) {
                tableBody.innerHTML = pageData.map(ad => {
                    const roasClass = ad.roas > 3 ? 'roas-high' : ad.roas > 1.5 ? 'roas-medium' : 'roas-low';
                    const formatClass = `format-${ad.format.toLowerCase()}`;
                    
                    let mediaLink = '—';
                    if (ad.media_url) {
                        const icon = ad.format === 'VIDEO' ? '🎬' : '🖼️';
                        mediaLink = `<a href="${ad.media_url}" target="_blank" class="media-link">${icon}</a>`;
                    }
                    
                    // Déterminer le badge d'état
                    const statusBadge = ad.effective_status === 'ACTIVE' 
                        ? '<span class="status-badge active">ACTIVO</span>'
                        : '<span class="status-badge paused">PAUSADO</span>';
                    
                    // Formater la date de début
                    const startDate = ad.created_time ? new Date(ad.created_time).toLocaleDateString('es-MX', {
                        day: '2-digit',
                        month: '2-digit',
                        year: '2-digit'
                    }) : '—';
                    
                    // Récupérer les valeurs sauvegardées
                    const savedAd = savedData[ad.ad_id] || {};
                    const hypothesis = savedAd.hypothesis || '';
                    const result = savedAd.result || '';
                    
                    return `
                        <tr data-ad-id="${ad.ad_id}">
                            <td class="ad-name" title="${ad.ad_name}">${ad.ad_name.substring(0, 40)}...</td>
                            <td>${statusBadge}</td>
                            <td><span class="format-badge ${formatClass}">${ad.format}</span></td>
                            <td>${startDate}</td>
                            <td class="metric">$${Math.round(parseFloat(ad.spend || 0)).toLocaleString()}</td>
                            <td class="metric ${roasClass}">${ad.roas.toFixed(2)}</td>
                            <td class="metric">$${ad.cpa > 0 ? ad.cpa.toFixed(0) : '—'}</td>
                            <td class="metric">${ad.purchases || 0}</td>
                            <td>${mediaLink}</td>
                            <td><input type="text" class="hypothesis-input" placeholder="Agregar hipótesis..." value="${hypothesis}" data-ad-id="${ad.ad_id}"></td>
                            <td>
                                <select class="result-select" data-ad-id="${ad.ad_id}">
                                    <option value="">—</option>
                                    <option value="ganador" ${result === 'ganador' ? 'selected' : ''}>✅ Ganador</option>
                                    <option value="perdedor" ${result === 'perdedor' ? 'selected' : ''}>❌ Perdedor</option>
                                </select>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Ajouter les contrôles de pagination
            renderPaginationControls(totalPages);
        }
        
        function renderPaginationControls(totalPages) {
            // Créer ou récupérer le conteneur de pagination
            let paginationContainer = document.querySelector('.pagination-controls');
            if (!paginationContainer) {
                paginationContainer = document.createElement('div');
                paginationContainer.className = 'pagination-controls';
                paginationContainer.style.cssText = `
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 10px;
                    margin-top: 20px;
                    padding: 15px;
                `;
                const tableCard = document.querySelector('.main-table-card');
                if (tableCard) {
                    tableCard.appendChild(paginationContainer);
                }
            }
            
            // Pagination simple et minimaliste
            paginationContainer.innerHTML = `
                <button onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''} 
                        style="padding: 8px 12px; border: 1px solid #e0e0e2; background: white; border-radius: 6px; cursor: pointer; ${currentPage === 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                    ←
                </button>
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} 
                        style="padding: 8px 12px; border: 1px solid #e0e0e2; background: white; border-radius: 6px; cursor: pointer; ${currentPage === 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                    Anterior
                </button>
                <span style="padding: 8px 16px; background: #f5f5f7; border-radius: 6px;">
                    Página <strong>${currentPage}</strong> de <strong>${totalPages}</strong>
                </span>
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} 
                        style="padding: 8px 12px; border: 1px solid #e0e0e2; background: white; border-radius: 6px; cursor: pointer; ${currentPage === totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                    Siguiente
                </button>
                <button onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''} 
                        style="padding: 8px 12px; border: 1px solid #e0e0e2; background: white; border-radius: 6px; cursor: pointer; ${currentPage === totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                    →
                </button>
            `;
        }
        
        function changePage(page) {
            const totalPages = Math.ceil(filteredTableData.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
            }
        }
        
        // Fonction de filtrage du tableau (définie globalement)
        window.applyTableFilters = function() {
            console.log('applyTableFilters appelée');
            const filters = document.querySelectorAll('.table-filter');
            const filterValues = {};
            
            filters.forEach(filter => {
                const column = parseInt(filter.getAttribute('data-column'));
                filterValues[column] = filter.value.toLowerCase();
            });
            
            console.log('Valeurs des filtres:', filterValues);
            console.log('Nombre de données avant filtre:', currentTableData.length);
            
            // Debug des formats disponibles
            if (filterValues[2]) {
                const formats = [...new Set(currentTableData.map(ad => ad.format))];
                console.log('Formats disponibles dans les données:', formats);
                console.log('Format recherché:', filterValues[2]);
            }
            
            // Debug: voir les valeurs de effective_status
            if (filterValues[1]) {
                console.log('Filtre Estado:', filterValues[1]);
                console.log('Valeurs effective_status uniques:', [...new Set(currentTableData.map(ad => ad.effective_status))]);
                console.log('Exemple de données:', currentTableData.slice(0, 3).map(ad => ({ 
                    name: ad.ad_name, 
                    status: ad.effective_status 
                })));
            }
            
            // Filtrer les données
            filteredTableData = currentTableData.filter(ad => {
                // Filtre colonne 0: Nom de l'annonce
                if (filterValues[0] && !ad.ad_name.toLowerCase().includes(filterValues[0])) return false;
                
                // Filtre colonne 1: État (active/paused)
                if (filterValues[1]) {
                    // Plus flexible : accepter ACTIVE/PAUSED ou toute autre valeur
                    const statusMatch = filterValues[1] === 'active' ? ad.effective_status === 'ACTIVE' : 
                                       filterValues[1] === 'paused' ? (ad.effective_status === 'PAUSED' || ad.effective_status !== 'ACTIVE') : true;
                    if (!statusMatch) return false;
                }
                
                // Filtre colonne 2: Format
                if (filterValues[2] && ad.format.toLowerCase() !== filterValues[2]) return false;
                
                // Filtre colonne 3: Date
                if (filterValues[3]) {
                    // Convertir la date de l'annonce (format: "30/06/25") en date comparable
                    const adDateStr = new Date(ad.created_time).toLocaleDateString('es-MX', {
                        day: '2-digit',
                        month: '2-digit',
                        year: '2-digit'
                    });
                    // Convertir en format YYYY-MM-DD pour comparaison
                    const [day, month, year] = adDateStr.split('/');
                    const adDate = `20${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    
                    // La date du filtre est déjà en format YYYY-MM-DD
                    if (adDate !== filterValues[3]) return false;
                }
                
                // Filtre colonne 4: Montant dépensé minimum
                if (filterValues[4] && parseFloat(ad.spend) < parseFloat(filterValues[4])) return false;
                
                // Filtre colonne 5: ROAS minimum
                if (filterValues[5] && ad.roas < parseFloat(filterValues[5])) return false;
                
                // Filtre colonne 6: CPA maximum
                if (filterValues[6] && ad.cpa > parseFloat(filterValues[6])) return false;
                
                // Filtre colonne 7: Achats minimum
                if (filterValues[7] && (ad.purchases || 0) < parseInt(filterValues[7])) return false;
                
                // Filtre colonne 9: Hypothèse
                const savedData = JSON.parse(localStorage.getItem('adHypotheses') || '{}');
                const adData = savedData[ad.ad_id] || {};
                if (filterValues[9] && !adData.hypothesis?.toLowerCase().includes(filterValues[9])) return false;
                
                // Filtre colonne 10: Résultat
                if (filterValues[10] && adData.result !== filterValues[10]) return false;
                
                return true;
            });
            
            currentPage = 1; // Retour à la première page après filtrage
            renderTable();
        }
        
        function updateFormatTable(data) {
            const ads = data.ads || [];
            
            // Calculer métriques par format
            const formatMetrics = {};
            
            ads.forEach(ad => {
                const fmt = ad.format;
                if (!formatMetrics[fmt]) {
                    formatMetrics[fmt] = {
                        count: 0,
                        totalSpend: 0,
                        totalRoas: 0,
                        totalCtr: 0,
                        totalPurchases: 0,
                        validRoas: 0,
                        validCtr: 0
                    };
                }
                
                formatMetrics[fmt].count += 1;
                formatMetrics[fmt].totalSpend += parseFloat(ad.spend || 0);
                formatMetrics[fmt].totalPurchases += (ad.purchases || 0);
                
                if (ad.roas > 0) {
                    formatMetrics[fmt].totalRoas += ad.roas;
                    formatMetrics[fmt].validRoas += 1;
                }
                const ctr = (parseFloat(ad.clicks || 0) / parseFloat(ad.impressions || 1)) * 100;
                if (ctr > 0) {
                    formatMetrics[fmt].totalCtr += ctr;
                    formatMetrics[fmt].validCtr += 1;
                }
            });
            
            // Remplir le tableau
            const formatTable = document.getElementById('formato-table');
            if (formatTable) {
                formatTable.innerHTML = Object.entries(formatMetrics)
                    .sort((a, b) => b[1].totalSpend - a[1].totalSpend)
                    .map(([fmt, metrics]) => {
                        const avgRoas = metrics.validRoas > 0 ? (metrics.totalRoas / metrics.validRoas) : 0;
                        const avgCtr = metrics.validCtr > 0 ? (metrics.totalCtr / metrics.validCtr) : 0;
                        const cpa = metrics.totalPurchases > 0 ? (metrics.totalSpend / metrics.totalPurchases) : 0;
                        
                        const formatClass = `format-${fmt.toLowerCase()}`;
                        
                        return `
                            <tr>
                                <td><span class="format-badge ${formatClass}">${fmt}</span></td>
                                <td class="metric">${metrics.count.toLocaleString()}</td>
                                <td class="metric">$${Math.round(metrics.totalSpend).toLocaleString()}</td>
                                <td class="metric">${avgRoas.toFixed(2)}</td>
                                <td class="metric">${cpa > 0 ? '$' + cpa.toFixed(2) : 'N/A'}</td>
                                <td class="metric">${metrics.totalPurchases.toLocaleString()}</td>
                                <td>${avgCtr.toFixed(2)}%</td>
                            </tr>
                        `;
                    }).join('');
            }
        }
        
        function updateComparisonTable() {
            const currentData = periodsData[currentPeriod];
            const prevData = prevWeekData;
            
            // Vérifier que les données sont disponibles
            if (!currentData || !currentData.ads) {
                console.warn('Données courantes non disponibles');
                return;
            }
            
            // Si pas de données de comparaison, afficher N/A
            if (!prevData || !prevData.ads || prevData.ads.length === 0) {
                const comparisonTable = document.getElementById('comparison-table');
                if (comparisonTable) {
                    comparisonTable.innerHTML = '<tr><td colspan="4" style="text-align: center;">Données de comparaison non disponibles</td></tr>';
                }
                return;
            }
            
            const current = currentData.ads || [];
            const previous = prevData.ads || [];
            
            // ✅ Fonction d'agrégation pondérée (correcte)
            const aggregate = (ads) => {
                const totalSpend = ads.reduce((sum, ad) => sum + parseFloat(ad.spend || 0), 0);
                const totalRevenue = ads.reduce((sum, ad) => sum + ad.purchase_value, 0);
                const totalPurchases = ads.reduce((sum, ad) => sum + (ad.purchases || 0), 0);
                
                return {
                    spend: totalSpend,
                    roas: totalSpend > 0 ? totalRevenue / totalSpend : 0,
                    cpa: totalPurchases > 0 ? totalSpend / totalPurchases : 0
                };
            };
            
            const currentMetrics = aggregate(current);
            const prevMetrics = aggregate(previous);
            
            // Calculer changements
            const spendChange = ((currentMetrics.spend - prevMetrics.spend) / prevMetrics.spend * 100);
            const roasChange = ((currentMetrics.roas - prevMetrics.roas) / prevMetrics.roas * 100);
            const cpaChange = prevMetrics.cpa > 0 ? ((currentMetrics.cpa - prevMetrics.cpa) / prevMetrics.cpa * 100) : 0;
            const adsChange = ((current.length - previous.length) / previous.length * 100);
            
            function formatChange(change) {
                const symbol = change > 0 ? '+' : '';
                const color = change > 0 ? '#00a854' : change < 0 ? '#ff3b30' : '#6c757d';
                return `<span style="color: ${color}; font-weight: 600;">${symbol}${change.toFixed(1)}%</span>`;
            }
            
            const comparisonTable = document.getElementById('comparison-table');
            if (comparisonTable) {
                comparisonTable.innerHTML = `
                    <tr>
                        <td class="metric">Anuncios Activos</td>
                        <td class="metric">${current.length.toLocaleString()}</td>
                        <td class="metric">${previous.length.toLocaleString()}</td>
                        <td>${formatChange(adsChange)}</td>
                    </tr>
                    <tr>
                        <td class="metric">Inversión Total</td>
                        <td class="metric">$${Math.round(currentMetrics.spend).toLocaleString()}</td>
                        <td class="metric">$${Math.round(prevMetrics.spend).toLocaleString()}</td>
                        <td>${formatChange(spendChange)}</td>
                    </tr>
                    <tr>
                        <td class="metric">ROAS Promedio</td>
                        <td class="metric">${currentMetrics.roas.toFixed(2)}</td>
                        <td class="metric">${prevMetrics.roas.toFixed(2)}</td>
                        <td>${formatChange(roasChange)}</td>
                    </tr>
                    <tr>
                        <td class="metric">CPA Promedio</td>
                        <td class="metric">${currentMetrics.cpa > 0 ? '$' + currentMetrics.cpa.toFixed(2) : 'N/A'}</td>
                        <td class="metric">${prevMetrics.cpa > 0 ? '$' + prevMetrics.cpa.toFixed(2) : 'N/A'}</td>
                        <td>${prevMetrics.cpa > 0 ? formatChange(cpaChange) : 'N/A'}</td>
                    </tr>
                `;
            }
        }
        
        // State filter compte
        let currentAccountName = 'Todos';

        // Helpers de filtrage/distribution
        function filterAdsByAccount(ads) {
            if (!ads) return [];
            if (!currentAccountName || currentAccountName === 'Todos') return ads;
            return ads.filter(a => a.account_name === currentAccountName);
        }
        function computeFormatDistribution(ads) {
            const dist = {};
            ads.forEach(a => { const f = a.format || 'UNKNOWN'; dist[f] = (dist[f]||0)+1; });
            return dist;
        }
        function buildAccountOptions() {
            const menu = document.getElementById('account-dropdown-menu');
            if (!menu) return;
            
            let names = [];
            if (accountsIndex && Array.isArray(accountsIndex.accounts)) {
                names = accountsIndex.accounts.map(a => a.name).filter(Boolean).sort();
            } else {
                // Fallback: union des comptes sur toutes les périodes chargées
                const allNames = new Set();
                [3,7,14,30,90].forEach(p => {
                    const d = periodsData[p];
                    if (d && d.ads) d.ads.forEach(a => { if (a.account_name) allNames.add(a.account_name); });
                });
                names = Array.from(allNames).sort();
            }
            
            // Construire le menu dropdown
            let menuHTML = `<div class="dropdown-option ${currentAccountName === 'Todos' ? 'active' : ''}" data-value="Todos">Todas las cuentas</div>`;
            names.forEach(n => {
                const displayName = n.length > 28 ? n.substring(0, 25) + '...' : n;
                menuHTML += `<div class="dropdown-option ${currentAccountName === n ? 'active' : ''}" data-value="${n}" title="${n}">${displayName}</div>`;
            });
            menu.innerHTML = menuHTML;
            
            // Ajouter les event listeners aux options
            menu.querySelectorAll('.dropdown-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const value = e.target.getAttribute('data-value');
                    selectAccount(value);
                    closeDropdown();
                });
            });
        }
        
        function selectAccount(value) {
            currentAccountName = value;
            const btnText = document.getElementById('account-dropdown-text');
            if (btnText) {
                btnText.textContent = value === 'Todos' ? 'Todas las cuentas' : 
                                     (value.length > 28 ? value.substring(0, 25) + '...' : value);
            }
            updateDashboard(currentPeriod);
        }
        
        let keyboardBuffer = '';
        let keyboardTimer = null;
        
        function toggleDropdown() {
            const menu = document.getElementById('account-dropdown-menu');
            const btn = document.getElementById('account-dropdown-btn');
            const arrow = btn.querySelector('svg');
            
            if (menu.style.display === 'none' || !menu.style.display) {
                menu.style.display = 'block';
                arrow.style.transform = 'translateY(-50%) rotate(180deg)';
                btn.style.background = 'white';
                btn.style.color = '#2563eb';
                btn.style.borderColor = 'white';
                
                // Activer la navigation clavier
                document.addEventListener('keydown', handleKeyboardNavigation);
            } else {
                closeDropdown();
            }
        }
        
        function handleKeyboardNavigation(e) {
            const menu = document.getElementById('account-dropdown-menu');
            if (menu.style.display === 'none' || !menu.style.display) return;
            
            // Navigation par lettres
            if (e.key.length === 1 && e.key.match(/[a-zA-Z0-9]/)) {
                // Accumuler les lettres tapées
                keyboardBuffer += e.key.toLowerCase();
                
                // Reset le buffer après 1 seconde
                clearTimeout(keyboardTimer);
                keyboardTimer = setTimeout(() => {
                    keyboardBuffer = '';
                }, 1000);
                
                // Trouver la première option qui commence par ces lettres
                const options = menu.querySelectorAll('.dropdown-option');
                for (let i = 0; i < options.length; i++) {
                    const option = options[i];
                    const text = option.textContent.toLowerCase();
                    if (text.startsWith(keyboardBuffer)) {
                        // Scroll le menu (pas la page!) pour mettre cette option en haut
                        const optionTop = option.offsetTop;
                        menu.scrollTop = optionTop;
                        
                        // La surligner temporairement
                        options.forEach(o => o.style.background = '');
                        option.style.background = '#f5f5f7';
                        break;
                    }
                }
            }
            
            // Escape pour fermer
            if (e.key === 'Escape') {
                closeDropdown();
            }
            
            // Enter pour sélectionner l'option survolée
            if (e.key === 'Enter') {
                const hoveredOption = menu.querySelector('.dropdown-option:hover');
                if (hoveredOption) {
                    const value = hoveredOption.getAttribute('data-value');
                    selectAccount(value);
                    closeDropdown();
                }
            }
        }
        
        function closeDropdown() {
            const menu = document.getElementById('account-dropdown-menu');
            const btn = document.getElementById('account-dropdown-btn');
            const arrow = btn.querySelector('svg');
            
            menu.style.display = 'none';
            arrow.style.transform = 'translateY(-50%)';
            btn.style.background = 'rgba(255,255,255,0.2)';
            btn.style.color = 'white';
            btn.style.borderColor = 'rgba(255,255,255,0.3)';
            
            // Désactiver la navigation clavier
            document.removeEventListener('keydown', handleKeyboardNavigation);
            keyboardBuffer = '';
        }

        // Event listeners pour le dropdown custom
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('account-dropdown-btn');
            if (btn) {
                btn.addEventListener('click', toggleDropdown);
            }
            
            // Fermer le dropdown si on clique ailleurs
            document.addEventListener('click', (e) => {
                const dropdown = document.querySelector('.custom-dropdown');
                if (dropdown && !dropdown.contains(e.target)) {
                    closeDropdown();
                }
            });
        });
        
        // Écouteur pour les selects (filtres et résultats)
        document.addEventListener('change', (e) => {
            // Filtres de tableau
            if (e.target && e.target.classList.contains('table-filter')) {
                console.log('Filtre changé:', e.target, 'Valeur:', e.target.value);
                window.applyTableFilters();
            }
            
            // Sauvegarder les résultats (Ganador/Perdedor)
            if (e.target && e.target.classList.contains('result-select')) {
                const adId = e.target.getAttribute('data-ad-id');
                const value = e.target.value;
                
                const savedData = JSON.parse(localStorage.getItem('adHypotheses') || '{}');
                if (!savedData[adId]) savedData[adId] = {};
                savedData[adId].result = value;
                localStorage.setItem('adHypotheses', JSON.stringify(savedData));
            }
        });
        
        // Écouteur pour les inputs text (filtres et hypothèses)
        document.addEventListener('input', (e) => {
            // Filtres de tableau (text inputs)
            if (e.target && e.target.classList.contains('table-filter')) {
                window.applyTableFilters();
            }
            
            // Sauvegarder les hypothèses
            if (e.target && e.target.classList.contains('hypothesis-input')) {
                const adId = e.target.getAttribute('data-ad-id');
                const value = e.target.value;
                
                const savedData = JSON.parse(localStorage.getItem('adHypotheses') || '{}');
                if (!savedData[adId]) savedData[adId] = {};
                savedData[adId].hypothesis = value;
                localStorage.setItem('adHypotheses', JSON.stringify(savedData));
            }
            
            // Filtres de table
            if (e.target && e.target.classList.contains('table-filter')) {
                applyTableFilters();
            }
        });
        
        // Export to Excel functionality
        function exportToExcel() {
            const savedData = JSON.parse(localStorage.getItem('adHypotheses') || '{}');
            
            // Prepare CSV content
            let csv = '\ufeff'; // UTF-8 BOM for Excel
            csv += 'Anuncio,Cuenta,Estado,Formato,Fecha Inicio,Importe Gastado,ROAS,CPA,Compras,CTR,CPM,Hipótesis,Resultado\n';
            
            filteredTableData.forEach(ad => {
                const hypothesis = savedData[ad.ad_id]?.hypothesis || '';
                const result = savedData[ad.ad_id]?.result || '';
                const startDate = ad.created_time ? new Date(ad.created_time).toLocaleDateString('es-MX') : '';
                const ctr = (parseFloat(ad.clicks || 0) / parseFloat(ad.impressions || 1) * 100).toFixed(2);
                
                // Escape commas and quotes in text fields
                const escapeCsv = (text) => {
                    text = String(text); // Ensure it's a string
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        return '"' + text.replace(/"/g, '""') + '"';
                    }
                    return text;
                };
                
                csv += [
                    escapeCsv(ad.ad_name),
                    escapeCsv(ad.account_name),
                    ad.effective_status,
                    ad.format,
                    startDate,
                    Math.round(parseFloat(ad.spend || 0)),
                    ad.roas.toFixed(2),
                    ad.cpa > 0 ? ad.cpa.toFixed(0) : '',
                    ad.purchases || 0,
                    ctr,
                    ad.cpm > 0 ? ad.cpm.toFixed(0) : '',
                    escapeCsv(hypothesis),
                    result === 'ganador' ? 'Ganador' : result === 'perdedor' ? 'Perdedor' : ''
                ].join(',') + '\n';
            });
            
            // Create blob and download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `creative_testing_${currentPeriod}d_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Add event listener for export button and demographics
        document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'export-excel') {
                exportToExcel();
            }
            
            if (e.target && e.target.id === 'load-demographics') {
                loadDemographics();
            }
        });
        
        // Demographics loading function (placeholder)
        async function loadDemographics() {
            const btn = document.getElementById('load-demographics');
            const originalText = btn.textContent;
            btn.textContent = '⏳ Cargando...';
            btn.disabled = true;
            
            // Simulación - en producción esto llamaría a la API con breakdowns
            setTimeout(() => {
                // Sample data for demonstration
                const ageData = [
                    { range: '18-24', spend: 125000, roas: 2.8, ctr: 1.2 },
                    { range: '25-34', spend: 245000, roas: 3.5, ctr: 1.5 },
                    { range: '35-44', spend: 189000, roas: 4.1, ctr: 1.8 },
                    { range: '45-54', spend: 98000, roas: 3.2, ctr: 1.3 },
                    { range: '55-64', spend: 67000, roas: 2.9, ctr: 1.1 },
                    { range: '65+', spend: 34000, roas: 2.5, ctr: 0.9 }
                ];
                
                const genderData = [
                    { gender: 'Mujeres', spend: 456000, roas: 3.7, percentage: 60 },
                    { gender: 'Hombres', spend: 302000, roas: 2.9, percentage: 40 }
                ];
                
                // Show demographics section
                document.getElementById('demographics-content').style.display = 'none';
                document.getElementById('demographics-loaded').style.display = 'block';
                
                // Populate age distribution
                const ageDiv = document.getElementById('age-distribution');
                const maxSpend = Math.max(...ageData.map(d => d.spend));
                ageDiv.innerHTML = ageData.map(d => `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="width: 60px; font-size: 13px;">${d.range}</span>
                        <div style="flex: 1; margin: 0 10px; background: #f0f0f2; border-radius: 4px; height: 24px; position: relative;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${(d.spend/maxSpend*100)}%; border-radius: 4px;"></div>
                        </div>
                        <span style="font-size: 13px; width: 80px; text-align: right;">$${(d.spend/1000).toFixed(0)}k</span>
                    </div>
                `).join('');
                
                // Populate gender distribution
                const genderDiv = document.getElementById('gender-distribution');
                genderDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                        ${genderData.map(d => `
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 10px;">${d.gender === 'Mujeres' ? '👩' : '👨'}</div>
                                <div style="font-size: 24px; font-weight: 700; color: #667eea;">${d.percentage}%</div>
                                <div style="font-size: 14px; color: #6c757d;">${d.gender}</div>
                                <div style="font-size: 16px; margin-top: 5px;">$${(d.spend/1000).toFixed(0)}k</div>
                                <div style="font-size: 14px; color: #00a854;">ROAS ${d.roas}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Populate demographics table
                const tableBody = document.getElementById('demographics-table');
                tableBody.innerHTML = ageData.map(d => `
                    <tr>
                        <td>${d.range} años</td>
                        <td class="metric">$${(d.spend).toLocaleString()}</td>
                        <td class="metric" style="color: ${d.roas > 3 ? '#00a854' : '#ff9500'}">${d.roas.toFixed(2)}</td>
                        <td>${d.ctr}%</td>
                        <td>$${(d.spend/d.roas/50).toFixed(0)}</td>
                        <td>${Math.round(d.spend/d.roas/1000)}</td>
                    </tr>
                `).join('');
                
                // Add message about real data
                const note = document.createElement('p');
                note.style.cssText = 'margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 13px; color: #856404;';
                note.innerHTML = '⚠️ Nota: Estos son datos de ejemplo. Para datos reales, se requiere una llamada adicional a la API con breakdown por edad/género.';
                document.getElementById('demographics-loaded').appendChild(note);
            }, 1500);
        }
        
        // Fonction de filtrage
        function applyTableFilters() {
            const filters = document.querySelectorAll('.table-filter');
            const savedData = JSON.parse(localStorage.getItem('adHypotheses') || '{}');
            
            filteredTableData = currentTableData.filter(ad => {
                let pass = true;
                
                filters.forEach(filter => {
                    const column = parseInt(filter.getAttribute('data-column'));
                    const value = filter.value.toLowerCase().trim();
                    
                    if (!value) return;
                    
                    switch(column) {
                        case 0: // Nombre del anuncio
                            if (!ad.ad_name.toLowerCase().includes(value)) pass = false;
                            break;
                        case 1: // Estado
                            if (value && ad.effective_status !== value) pass = false;
                            break;
                        case 2: // Formato
                            if (value && ad.format !== value) pass = false;
                            break;
                        case 3: // Fecha inicio
                            if (value && ad.created_time) {
                                const adDate = new Date(ad.created_time).toISOString().split('T')[0];
                                if (adDate < value) pass = false;
                            }
                            break;
                        case 4: // Spend mínimo
                            if (value && parseFloat(ad.spend || 0) < parseFloat(value)) pass = false;
                            break;
                        case 5: // ROAS mínimo
                            if (value && ad.roas < parseFloat(value)) pass = false;
                            break;
                        case 6: // CPA máximo
                            if (value && ad.cpa > parseFloat(value)) pass = false;
                            break;
                        case 7: // Compras mínimas
                            if (value && (ad.purchases || 0) < parseInt(value)) pass = false;
                            break;
                        case 9: // Hipótesis
                            const hypothesis = savedData[ad.ad_id]?.hypothesis || '';
                            if (!hypothesis.toLowerCase().includes(value)) pass = false;
                            break;
                        case 10: // Resultado
                            const result = savedData[ad.ad_id]?.result || '';
                            if (value && result !== value) pass = false;
                            break;
                    }
                });
                
                return pass;
            });
            
            renderTable();
        }

        // Charger les données au démarrage
        document.addEventListener('DOMContentLoaded', async () => {
            // Afficher "Chargement..." dans les KPIs
            const kpiCards = document.querySelectorAll('.kpi-content h3');
            kpiCards.forEach(card => card.textContent = '...');
            
            await loadAllData();
            buildAccountOptions();
        });
    </script>
</body>
</html>
